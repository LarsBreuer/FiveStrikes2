//  Copyright 2006-2010 okonet.ru. All rights reserved.
if(Object.isUndefined(Prototype.Browser.IE6)&&(Prototype.Browser.IE6=-1!=navigator.appName.indexOf("Microsoft Internet Explorer")&&-1!=navigator.appVersion.indexOf("MSIE 6.0")&&!window.XMLHttpRequest),!window.Modalbox)var Modalbox={};Modalbox.Methods={overrideAlert:!1,focusableElements:[],currFocused:0,initialized:!1,active:!0,options:{title:"ModalBox Window",overlayClose:!0,width:500,height:90,overlayOpacity:.65,overlayDuration:.25,slideDownDuration:.5,slideUpDuration:.5,resizeDuration:.25,inactiveFade:!0,transitions:!0,loadingString:"Please wait. Loading...",closeString:"Close window",closeValue:"&times;",params:{},method:"get",autoFocusing:!0,aspnet:!1,resizeCSSID:""},_options:{},setOptions:function(t){Object.extend(this.options,t||{})},_init:function(t){Object.extend(this._options,this.options),this.setOptions(t),this.MBoverlay=new Element("div",{id:"MB_overlay",style:"opacity: 0"}),this.MBwindowwrapper=new Element("div",{id:"MB_windowwrapper"}).update(this.MBwindow=new Element("div",{id:"MB_window",style:"display: none"}).update(this.MBframe=new Element("div",{id:"MB_frame"}).update(this.MBheader=new Element("div",{id:"MB_header"}).update(this.MBcaption=new Element("div",{id:"MB_caption"}))))),this.MBclose=new Element("a",{id:"MB_close",title:this.options.closeString,href:"#"}).update("<span>"+this.options.closeValue+"</span>"),this.MBheader.insert({bottom:this.MBclose}),this.MBcontent=new Element("div",{id:"MB_content"}).update(this.MBloading=new Element("div",{id:"MB_loading"}).update(this.options.loadingString)),this.MBframe.insert({bottom:this.MBcontent});var e=this.options.aspnet?$(document.body).down("form"):$(document.body);e.insert({top:this.MBwindowwrapper}),e.insert({top:this.MBoverlay});var i=document.viewport.getScrollOffsets();i[1]>0&&$("MB_window").setStyle({top:i[1]+"px"}),i[0]>0&&$("MB_window").setStyle({left:i[0]+"px"}),Event.observe(window,"scroll",function(){i=document.viewport.getScrollOffsets(),$("MB_window").setStyle({top:i[1]+"px"}),$("MB_window").setStyle({left:i[0]+"px"})}),this.initScrollX=window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft,this.initScrollY=window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop,this.hideObserver=this._hide.bindAsEventListener(this),this.kbdObserver=this._kbdHandler.bindAsEventListener(this),this.resizeObserver=this._setWidthAndPosition.bindAsEventListener(this),this._initObservers(),this.initialized=!0},show:function(t,e){this.initialized||this._init(e),this._cleanUpContentIDs(),this.content=t,this.setOptions(e),this.options.title?this.MBcaption.update(this.options.title):(this.MBheader.hide(),this.MBcaption.hide()),"none"==this.MBwindow.style.display?(this._appear(),this.event("onShow")):(this._update(),this.event("onUpdate"))},hide:function(t){if(!this.initialized)throw"Modalbox is not initialized.";t&&!Object.isFunction(t.element)&&Object.extend(this.options,t),this.event("beforeHide"),this.options.transitions?Effect.SlideUp(this.MBwindow,{duration:this.options.slideUpDuration,transition:Effect.Transitions.sinoidal,afterFinish:this._deinit.bind(this)}):(this.MBwindow.hide(),this._deinit()),Event.stopObserving(window,"scroll")},_hide:function(t){return t.stop(),"MB_overlay"!=t.element().id||this.options.overlayClose?(this.hide(),void 0):!1},alert:function(t){var e='<div class="MB_alert"><p>'+t+'</p><input type="button" onclick="Modalbox.hide()" value="OK" /></div>';Modalbox.show(e,{title:"Alert: "+document.title,width:300})},_appear:function(){Prototype.Browser.IE6&&(window.scrollTo(0,0),this._prepareIEHtml("100%","hidden"),this._prepareIESelects("hidden")),this._setWidth(),this.options.transitions?(this.MBoverlay.setOpacity(0),new Effect.Fade(this.MBoverlay,{from:0,to:this.options.overlayOpacity,duration:this.options.overlayDuration,afterFinish:function(){new Effect.SlideDown(this.MBwindow,{duration:this.options.slideDownDuration,transition:Effect.Transitions.sinoidal,afterFinish:this.loadContent.bind(this)})}.bind(this)})):(this.MBoverlay.setOpacity(this.options.overlayOpacity),this.MBwindow.show(),this.loadContent()),Event.observe(window,"resize",this.resizeObserver)},resize:function(t,e,i){$(this.MBoverlay).getWidth();var s=$(this.MBwindow).getHeight(),o=$(this.MBwindow).getWidth(),n=$(this.MBheader).getHeight(),r=$(this.MBcontent).getHeight(),h=r>s-n+e?r+n:s+e,a=$(this.MBwindow),d=$(this.MBcontent),l=10;h+=l;var c=parseInt(a.getStyle("margin-top"),0)+parseInt(a.getStyle("margin-bottom"),0)+parseInt(a.getStyle("border-top-width"),0)+parseInt(a.getStyle("border-bottom-width"),0)+l,p=parseInt(d.getStyle("padding-top"))+parseInt(d.getStyle("padding-bottom"));h+c+p>document.viewport.getHeight()?(h=document.viewport.getHeight()-c-l,newcHeight=h-n-parseInt($(this.MBframe).getStyle("padding-bottom"),0)-parseInt($(this.MBcontent).getStyle("padding-bottom"),0),$(this.MBcontent).setStyle({height:newcHeight+"px"})):$(this.MBcontent).getStyle("height")&&$(this.MBcontent).setStyle({height:""});var u=o+t,w={width:u+"px",height:h+"px"};this.options.width=u,i&&this.setOptions(i),this.options.transitions&&!Modalbox.animating?(Modalbox.animating=!0,new Effect.Morph(this.MBwindow,{style:w,duration:this.options.resizeDuration,beforeStart:function(t){t.element.setStyle({overflow:"hidden"})},afterFinish:function(t){t.element.setStyle({overflow:"visible"}),this.event("_afterResize"),this.event("afterResize"),Modalbox.animating=!1}.bind(this)})):(this.MBwindow.setStyle(w),function(){this.event("_afterResize"),this.event("afterResize")}.bind(this).defer())},resizeToContent:function(t){"undefined"==typeof t&&(t={});var e=$("MB_content").select("img"),i=e.length;if(e[0]&&"undefined"==typeof t.imagesloaded){var s=$A(),o=0;e.each(function(n,r){s[r]=new Image,s[r].src=n.src,s[r].onload=function(){if(o++,o==i){var s=!1;e.each(function(t){0==t.height&&(s=!0)}),s||Modalbox.animating?Modalbox.resizeToContent():(t.imagesloaded=!0,Modalbox.resizeToContent(t))}}})}var n=0,r=this.options.height-this.MBwindow.getHeight();t.resizeCSSID&&$(t.resizeCSSID)&&(n=$(t.resizeCSSID).getWidth()-$(this.MBwindow).getWidth()+(parseInt($(this.MBcontent).getStyle("padding-left"),0)+parseInt($(this.MBcontent).getStyle("padding-right"),0))+15),0!=r&&this.resize(n,r,t)},resizeToInclude:function(t,e){var i=$(t),s=i.getHeight()+parseInt(i.getStyle("margin-top"),0)+parseInt(i.getStyle("margin-bottom"),0)+parseInt(i.getStyle("border-top-width"),0)+parseInt(i.getStyle("border-bottom-width"),0);s>0&&this.resize(0,s,e)},_update:function(){this.MBcontent.update($(this.MBloading).update(this.options.loadingString)),this.loadContent()},loadContent:function(){if(0!=this.event("beforeLoad"))if("string"==typeof this.content){var t=new RegExp(/<\/?[^>]+>/gi);t.test(this.content)?this._processContent(this.content):new Ajax.Request(this.content,{method:this.options.method.toLowerCase(),parameters:this.options.params,onComplete:function(t){this._processContent(t.responseText)}.bind(this),onException:function(t,e){throw Modalbox.hide(),"Modalbox Loading Error: "+e}})}else{if("object"!=typeof this.content)throw this.hide(),"Modalbox Parameters Error: Please specify correct URL or HTML element (plain HTML or object)";this._insertContent(this.content)}},_processContent:function(content){var html=content.stripScripts(),scripts=content.extractScripts();this._insertContent(html,function(){scripts.map(function(script){return eval(script.replace("<!--","").replace("// -->",""))},window)})},_insertContent:function(t,e){if(this.MBcontent.hide().update(),"string"==typeof t)this.MBcontent.insert(new Element("div",{style:"display: none"}).update(t)).down().show();else if("object"==typeof t){var i=t.cloneNode(!0);t.id&&(t.id="MB_"+t.id),$(t).select("*[id]").each(function(t){t.id="MB_"+t.id}),this.MBcontent.insert(i).down("div").show(),Prototype.Browser.IE6&&this._prepareIESelects("","#MB_content ")}this.options.height==this._options.height?this.resize(this.options.width-$(this.MBwindow).getWidth(),this.MBcontent.getHeight()-$(this.MBwindow).getHeight()+this.MBheader.getHeight(),{afterResize:function(){this._putContent.bind(this,e).defer()}.bind(this)}):(this._setWidth(),this.MBcontent.setStyle({overflow:"auto",height:this.MBwindow.getHeight()-this.MBheader.getHeight()-13+"px"}),this._putContent.bind(this,e).defer())},_putContent:function(t){this.MBcontent.show(),this._findFocusableElements(),this._setFocus(),Object.isFunction(t)&&t(),this.event("afterLoad")},activate:function(t){this.setOptions(t),this.active=!0,this.options.overlayClose&&this.MBoverlay.observe("click",this.hideObserver),this.MBclose.observe("click",this.hideObserver).show(),this.options.transitions&&this.options.inactiveFade&&new Effect.Appear(this.MBwindow,{duration:this.options.slideUpDuration})},deactivate:function(t){this.setOptions(t),this.active=!1,this.options.overlayClose&&this.MBoverlay.stopObserving("click",this.hideObserver),this.MBclose.stopObserving("click",this.hideObserver).hide(),this.options.transitions&&this.options.inactiveFade&&new Effect.Fade(this.MBwindow,{duration:this.options.slideUpDuration,to:.75})},_initObservers:function(){this.MBclose.observe("click",this.hideObserver),this.options.overlayClose&&this.MBoverlay.observe("click",this.hideObserver);var t=Prototype.Browser.Gecko||Prototype.Browser.Opera?"keypress":"keydown";Event.observe(document,t,this.kbdObserver)},_removeObservers:function(){this.MBclose.stopObserving("click",this.hideObserver),this.options.overlayClose&&this.MBoverlay.stopObserving("click",this.hideObserver);var t=Prototype.Browser.Gecko||Prototype.Browser.Opera?"keypress":"keydown";Event.stopObserving(document,t,this.kbdObserver)},_setFocus:function(){if(this.options.autoFocusing)if(this.focusableElements.length){var t=this.focusableElements.find(function(t){return 1==t.tabIndex})||this.focusableElements.first();this.currFocused=this.focusableElements.toArray().indexOf(t),t.focus()}else this.MBclose.visible()&&this.MBclose.focus()},_findFocusableElements:function(){this.focusableElements=this.MBcontent.select("input:not([type=hidden]):enabled, select, textarea, button, a[href]")},_kbdHandler:function(t){var e=t.element();switch(t.keyCode){case Event.KEY_TAB:if(t.stop(),this._findFocusableElements(),!this.focusableElements.length)return!1;e!=this.focusableElements[this.currFocused]&&(this.currFocused=this.focusableElements.indexOf(e)),t.shiftKey?this.currFocused<=0?this.currFocused=this.focusableElements.length-1:this.currFocused--:this.currFocused>=this.focusableElements.length-1?this.currFocused=0:this.currFocused++,this.focusableElements[this.currFocused].focus();break;case Event.KEY_ESC:this.active&&this._hide(t);break;case 32:this._preventScroll(t);break;case 0:32==t.which&&this._preventScroll(t);break;case Event.KEY_UP:case Event.KEY_DOWN:case Event.KEY_PAGEDOWN:case Event.KEY_PAGEUP:case Event.KEY_HOME:case Event.KEY_END:var i=e.tagName.toLowerCase();Prototype.Browser.WebKit&&!["textarea","select"].include(i)?t.stop():("input"==i&&["submit","button"].include(e.type)||"a"==i)&&t.stop()}},_preventScroll:function(t){["input","textarea","select","button"].include(t.element().tagName.toLowerCase())||t.stop()},_deinit:function(){this._removeObservers(),Event.stopObserving(window,"resize",this.resizeObserver),this.options.transitions?Effect.toggle(this.MBoverlay,"appear",{duration:this.options.overlayDuration,afterFinish:this._removeElements.bind(this)}):(this.MBoverlay.hide(),this._removeElements()),this.MBcontent.setStyle({overflow:"",height:""})},_cleanUpContentIDs:function(){"object"==typeof this.content&&(this.content.id&&this.content.id.match(/MB_/)&&(this.content.id=this.content.id.replace(/MB_/,"")),this.content.select("*[id]").each(function(t){t.id=t.id.replace(/MB_/,"")}))},_removeElements:function(){Prototype.Browser.Opera&&window.scrollBy(0,0),this.MBoverlay.remove(),$(this.MBwindowwrapper).remove(),Prototype.Browser.IE6&&(this._prepareIEHtml("",""),this._prepareIESelects(""),window.scrollTo(this.initScrollX,this.initScrollY)),this._cleanUpContentIDs(),this.initialized=!1,this.event("afterHide"),this.setOptions(this._options)},_setWidth:function(){this.MBwindow.setStyle({width:this.options.width+"px",height:this.options.height+"px"})},_setWidthAndPosition:function(){this.MBwindow.setStyle({width:this.options.width+"px"})},_prepareIEHtml:function(t,e){$$("html, body").invoke("setStyle",{width:t,height:t,overflow:e})},_prepareIESelects:function(t,e){$$((e||"")+"select").invoke("setStyle",{visibility:t})},event:function(t){var e=!0;if(this.options[t]){var i=this.options[t]();this.options[t]=null,Object.isUndefined(i)||(e=i)}return e}},Object.extend(Modalbox,Modalbox.Methods),Modalbox.overrideAlert&&(window.alert=Modalbox.alert);